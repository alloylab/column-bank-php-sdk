include:
  - template: SAST.gitlab-ci.yml
  - template: Dependency-Scanning.gitlab-ci.yml
  - template: Secret-Detection.gitlab-ci.yml

stages:
  - test
  - security

phpstan:
  stage: test
  image:
    name: ghcr.io/phpstan/phpstan:latest
    entrypoint: [""]
  variables:
    APP_PATH: $CI_PROJECT_DIR/src
  script:
    - apk update && apk add curl patch;
    - curl -sSLf -o /usr/local/bin/install-php-extensions https://github.com/mlocati/docker-php-extension-installer/releases/latest/download/install-php-extensions
    - chmod +x /usr/local/bin/install-php-extensions
    - install-php-extensions zip
    - cd $APP_PATH && composer install --optimize-autoloader --ignore-platform-reqs;
    - $APP_PATH/vendor/bin/phpstan analyse -c phpstan.neon;
  artifacts:
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "dev"

sast:
  stage: security
  artifacts:
    expire_in: 1 week

dependency_scanning:
  stage: security
  artifacts:
    expire_in: 1 week

secret_detection:
  stage: security
  artifacts:
    expire_in: 1 week